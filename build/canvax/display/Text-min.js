define("canvax/display/Text",["canvax/display/DisplayObject","canvax/core/Base"],function(a,b){var c=function(a,c){var d=this;d.type="text",d._reNewline=/\r?\n/,d.fontProperts=["fontStyle","fontVariant","fontWeight","fontSize","fontFamily"],c=b.checkOpt(c),d._context={fontSize:c.context.fontSize||13,fontWeight:c.context.fontWeight||"normal",fontFamily:c.context.fontFamily||"微软雅黑",textDecoration:c.context.textDecoration,fillStyle:c.context.fontColor||c.context.fillStyle||"blank",lineHeight:c.context.lineHeight||1.3,backgroundColor:c.context.backgroundColor,textBackgroundColor:c.context.textBackgroundColor},d._context.font=d._getFontDeclaration(),d.text=a.toString(),arguments.callee.superclass.constructor.apply(this,[c])};return b.creatClass(c,DisplayObjectContainer,{$watch:function(a){a in this.fontProperts&&(this._notWatch=!1,this.context.font=this._getFontDeclaration())},init:function(){},render:function(a){var b=this._getTextLines();this.context.width=this._getTextWidth(a,b),this.context.height=this._getTextHeight(a,b);for(p in this.context.$model)p in a&&"textBaseline"!=p&&this.context.$model[p]&&(a[p]=this.context.$model[p]);this._renderTextBackground(a,b),this._renderText(a,b)},resetText:function(a){this.text=a.toString(),this.heartBeat()},getTextWidth:function(){var a=0;return b._pixelCtx.save(),b._pixelCtx.font=this.context.font,a=this._getTextWidth(b._pixelCtx,this._getTextLines()),b._pixelCtx.restore(),a},getTextHeight:function(){return this._getTextHeight(b._pixelCtx,this._getTextLines())},_getTextLines:function(){return this.text.split(this._reNewline)},_renderText:function(a,b){a.save(),this._renderTextFill(a,b),this._renderTextStroke(a,b),a.restore()},_getFontDeclaration:function(){var a=this,b=[];return _.each(this.fontProperts,function(c){var d=a._context[c];"fontSize"==c&&(d=parseFloat(d)+"px"),d&&b.push(d)}),b.join(" ")},_renderTextFill:function(a,b){if(this.context.fillStyle){this._boundaries=[];for(var c=0,d=0,e=b.length;e>d;d++){var f=this._getHeightOfLine(a,d,b);c+=f,this._renderTextLine("fillText",a,b[d],0,this._getTopOffset()+c,d)}}},_renderTextStroke:function(a,b){if(this.context.strokeStyle&&this.context.lineWidth||this._skipFillStrokeCheck){var c=0;a.save(),this.strokeDashArray&&(1&this.strokeDashArray.length&&this.strokeDashArray.push.apply(this.strokeDashArray,this.strokeDashArray),supportsLineDash&&a.setLineDash(this.strokeDashArray)),a.beginPath();for(var d=0,e=b.length;e>d;d++){var f=this._getHeightOfLine(a,d,b);c+=f,this._renderTextLine("strokeText",a,b[d],0,this._getTopOffset()+c,d)}a.closePath(),a.restore()}},_renderTextLine:function(a,b,c,d,e,f){if(e-=this.context.fontSize/4,"justify"!==this.context.textAlign)return this._renderChars(a,b,c,d,e,f),void 0;var g=b.measureText(c).width,h=this.context.width;if(h>g)for(var i=c.split(/\s+/),j=b.measureText(c.replace(/\s+/g,"")).width,k=h-j,l=i.length-1,m=k/l,n=0,o=0,p=i.length;p>o;o++)this._renderChars(a,b,i[o],d+n,e,f),n+=b.measureText(i[o]).width+m;else this._renderChars(a,b,c,d,e,f)},_renderChars:function(a,b,c,d,e){b[a](c,0,e)},_getHeightOfLine:function(){return this.context.fontSize*this.context.lineHeight},_getTextWidth:function(a,b){for(var c=a.measureText(b[0]||"|").width,d=1,e=b.length;e>d;d++){var f=a.measureText(b[d]).width;f>c&&(c=f)}return c},_getTextHeight:function(a,b){return this.context.fontSize*b.length*this.context.lineHeight},_renderTextBackground:function(a,b){this._renderTextBoxBackground(a),this._renderTextLinesBackground(a,b)},_renderTextBoxBackground:function(a){this.context.backgroundColor&&(a.save(),a.fillStyle=this.context.backgroundColor,a.fillRect(this._getLeftOffset(),this._getTopOffset(),this.context.width,this.context.height),a.restore())},_renderTextLinesBackground:function(a,b){if(this.context.textBackgroundColor){a.save(),a.fillStyle=this.context.textBackgroundColor;for(var c=0,d=b.length;d>c;c++)if(""!==b[c]){var e=this._getLineWidth(a,b[c]),f=this._getLineLeftOffset(e);a.fillRect(this._getLeftOffset()+f,this._getTopOffset()+c*this.context.fontSize*this.context.lineHeight,e,this.context.fontSize*this.context.lineHeight)}a.restore()}},_getLineWidth:function(a,b){return"justify"===this.context.textAlign?this.context.width:a.measureText(b).width},_getLineLeftOffset:function(a){return"center"===this.context.textAlign?(this.context.width-a)/2:"right"===this.context.textAlign?this.context.width-a:0},_getLeftOffset:function(){var a=0;switch(this.context.textAlign){case"left":a=0;break;case"center":a=-this.context.width/2;break;case"right":a=-this.context.width}return a},_getTopOffset:function(){var a=0;switch(this.context.textBaseline){case"top":a=0;break;case"middle":a=-this.context.height/2;break;case"bottom":a=-this.context.height}return a}}),c});